@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gestione Prenotazioni</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <h1>Gestione Prenotazioni</h1>

    <!-- Modulo per creare una nuova prenotazione -->
    <div id="createForm">
        <h2>Crea Nuova Prenotazione</h2>
        <form id="createPrenotazioneForm">
            <!-- Selezione del cliente -->
            <label for="clienteId">Cliente:</label>
            <select id="clienteId" name="clienteId" required>
                <!-- Le opzioni saranno caricate dinamicamente -->
            </select><br />

            <!-- Selezione della camera -->
            <label for="cameraId">Camera:</label>
            <select id="cameraId" name="cameraId" required>
                <!-- Le opzioni saranno caricate dinamicamente -->
            </select><br />

            <label for="createDataPrenotazione">Data Prenotazione:</label>
            <input type="date" id="createDataPrenotazione" name="dataPrenotazione" required /><br />
            <label for="createDataInizio">Data Inizio:</label>
            <input type="date" id="createDataInizio" name="dataInizio" required /><br />
            <label for="createDataFine">Data Fine:</label>
            <input type="date" id="createDataFine" name="dataFine" required /><br />
            <label for="createCaparra">Caparra:</label>
            <input type="number" step="0.01" id="createCaparra" name="caparra" required /><br />
            <label for="createTariffa">Tariffa:</label>
            <input type="number" step="0.01" id="createTariffa" name="tariffa" required /><br />
            <label for="createServizioCamera">Servizio Camera:</label>
            <select id="createServizioCamera" name="servizioCamera" required>
                <option value="pernottamento con prima colazione">Pernottamento con prima colazione</option>
                <option value="pensione completa">Pensione completa</option>
                <option value="mezza pensione">Mezza pensione</option>
            </select><br />
            <button type="submit">Crea</button>
        </form>
    </div>

    <table id="prenotazioniTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Data Prenotazione</th>
                <th>Periodo</th>
                <th>Caparra</th>
                <th>Tariffa</th>
                <th>Servizio Camera</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <h2>Crea Cliente</h2>
    <form id="createClienteForm">
        <input type="text" name="codiceFiscale" placeholder="Codice Fiscale" required><br />
        <input type="text" name="nome" placeholder="Nome" required><br />
        <input type="text" name="cognome" placeholder="Cognome" required><br />
        <input type="text" name="citta" placeholder="Città" required><br />
        <input type="text" name="provincia" placeholder="Provincia" required><br />
        <input type="email" name="email" placeholder="Email" required><br />
        <input type="text" name="telefono" placeholder="Telefono" required><br />
        <input type="text" name="cellulare" placeholder="Cellulare" required><br />
        <button type="submit">Crea Cliente</button>
    </form>

    <h2>Crea Camera</h2>
    <form id="createCameraForm">
        <input type="number" name="numeroCamera" placeholder="Numero Camera" required><br />
        <input type="text" name="descrizione" placeholder="Descrizione"><br />
        <select name="tipologia" required>
            <option value="">Seleziona Tipologia</option>
            <option value="singola">Singola</option>
            <option value="doppia">Doppia</option>
        </select><br />
        <button type="submit">Crea Camera</button>
    </form>

    <!-- Modulo per aggiornare una prenotazione -->
    <div id="updateForm" style="display: none;">
        <h2>Aggiorna Prenotazione</h2>
        <form id="updatePrenotazioneForm">
            <input type="hidden" id="updateId" name="id" />
            <label for="updateDataPrenotazione">Data Prenotazione:</label>
            <input type="date" id="updateDataPrenotazione" name="dataPrenotazione" required /><br />
            <label for="updateDataInizio">Data Inizio:</label>
            <input type="date" id="updateDataInizio" name="dataInizio" required /><br />
            <label for="updateDataFine">Data Fine:</label>
            <input type="date" id="updateDataFine" name="dataFine" required /><br />
            <label for="updateCaparra">Caparra:</label>
            <input type="number" step="0.01" id="updateCaparra" name="caparra" required /><br />
            <label for="updateTariffa">Tariffa:</label>
            <input type="number" step="0.01" id="updateTariffa" name="tariffa" required /><br />
            <label for="updateServizioCamera">Servizio Camera:</label>
            <select id="updateServizioCamera" name="servizioCamera" required>
                <option value="pernottamento con prima colazione">Pernottamento con prima colazione</option>
                <option value="pensione completa">Pensione completa</option>
                <option value="mezza pensione">Mezza pensione</option>
            </select><br />
            <button type="submit">Aggiorna</button>
        </form>
    </div>

    <script>
        $(document).ready(function () {
            const token = localStorage.getItem('jwtToken');  // Assuming you have saved the token in local storage

            function fetchPrenotazioni() {
                $.ajax({
                    url: '/api/Prenotazioni',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function (data) {
                        var tableBody = $('#prenotazioniTable tbody');
                        tableBody.empty();
                        data.forEach(function (prenotazione) {
                            tableBody.append(`
                                    <tr>
                                        <td>${prenotazione.id}</td>
                                        <td>${new Date(prenotazione.dataPrenotazione).toLocaleDateString()}</td>
                                        <td>${new Date(prenotazione.dataInizio).toLocaleDateString()} - ${new Date(prenotazione.dataFine).toLocaleDateString()}</td>
                                        <td>${prenotazione.caparra}</td>
                                        <td>${prenotazione.tariffa}</td>
                                        <td>${prenotazione.servizioCamera}</td>
                                        <td>
                                            <button onclick="editPrenotazione(${prenotazione.id})">Edit</button>
                                            <button onclick="deletePrenotazione(${prenotazione.id})">Delete</button>
                                            <button onclick="checkoutPrenotazione(${prenotazione.id})">Checkout</button>
                                        </td>
                                    </tr>
                                `);
                        });
                    },
                    error: function (error) {
                        console.error('Error fetching prenotazioni:', error);
                    }
                });
            }

            fetchPrenotazioni();  // Initial call to fetch prenotazioni

            window.editPrenotazione = function (id) {
                $.ajax({
                    url: '/api/Prenotazioni/' + id,
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function (prenotazione) {
                        $('#updateId').val(prenotazione.id);
                        $('#updateDataPrenotazione').val(new Date(prenotazione.dataPrenotazione).toISOString().split('T')[0]);
                        $('#updateDataInizio').val(new Date(prenotazione.dataInizio).toISOString().split('T')[0]);
                        $('#updateDataFine').val(new Date(prenotazione.dataFine).toISOString().split('T')[0]);
                        $('#updateCaparra').val(prenotazione.caparra);
                        $('#updateTariffa').val(prenotazione.tariffa);
                        $('#updateServizioCamera').val(prenotazione.servizioCamera);
                        $('#updateForm').show();
                    },
                    error: function (error) {
                        console.error('Error fetching prenotazione for editing:', error);
                    }
                });
            };

            window.deletePrenotazione = function (id) {
                if (confirm('Sei sicuro di voler eliminare questa prenotazione?')) {
                    $.ajax({
                        url: '/api/Prenotazioni/' + id,
                        type: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        success: function () {
                            fetchPrenotazioni();
                        },
                        error: function (error) {
                            console.error('Error deleting prenotazione:', error);
                        }
                    });
                }
            };

            $('#createPrenotazioneForm').submit(function (e) {
                e.preventDefault();
                var prenotazione = {
                    ClienteID: $('#clienteId').val(),
                    CameraID: $('#cameraId').val(),
                    DataPrenotazione: $('#createDataPrenotazione').val(),
                    DataInizio: $('#createDataInizio').val(),
                    DataFine: $('#createDataFine').val(),
                    Caparra: $('#createCaparra').val(),
                    Tariffa: $('#createTariffa').val(),
                    ServizioCamera: $('#createServizioCamera').val()
                };

                // Controlla se tutti i campi sono compilati
                if (!prenotazione.ClienteID || !prenotazione.CameraID || !prenotazione.DataPrenotazione || !prenotazione.DataInizio || !prenotazione.DataFine || !prenotazione.Caparra || !prenotazione.Tariffa || !prenotazione.ServizioCamera) {
                    alert('Tutti i campi sono richiesti.');
                    return;
                }

                $.ajax({
                    url: '/api/Prenotazioni',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(prenotazione),
                    success: function () {
                        alert('Prenotazione creata con successo!');
                        fetchPrenotazioni();
                        $('#createPrenotazioneForm')[0].reset();
                    },
                    error: function (xhr) {
                        alert('Errore nella creazione della prenotazione: ' + xhr.responseText);
                    }
                });
            });

            $('#updatePrenotazioneForm').submit(function (e) {
                e.preventDefault();
                var id = $('#updateId').val();
                var prenotazione = {
                    ID: id,
                    DataPrenotazione: $('#updateDataPrenotazione').val(),
                    DataInizio: $('#updateDataInizio').val(),
                    DataFine: $('#updateDataFine').val(),
                    Caparra: $('#updateCaparra').val(),
                    Tariffa: $('#updateTariffa').val(),
                    ServizioCamera: $('#updateServizioCamera').val()
                };
                $.ajax({
                    url: '/api/Prenotazioni/' + id,
                    type: 'PUT',
                    contentType: 'application/json',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    data: JSON.stringify(prenotazione),
                    success: function () {
                        fetchPrenotazioni();
                        $('#updateForm').hide();
                    },
                    error: function (error) {
                        console.error('Error updating prenotazione:', error);
                    }
                });
            });

            $('#createClienteForm').submit(function (event) {
                event.preventDefault();
                var clienteData = {
                    CodiceFiscale: $('input[name="codiceFiscale"]').val(),
                    Nome: $('input[name="nome"]').val(),
                    Cognome: $('input[name="cognome"]').val(),
                    Citta: $('input[name="citta"]').val(),
                    Provincia: $('input[name="provincia"]').val(),
                    Email: $('input[name="email"]').val(),
                    Telefono: $('input[name="telefono"]').val(),
                    Cellulare: $('input[name="cellulare"]').val()
                };

                $.ajax({
                    url: 'https://localhost:7153/api/Clienti/Create',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(clienteData),
                    success: function (response) {
                        alert('Cliente creato con successo!');
                        fetchClienti();
                    },
                    error: function () {
                        alert('Errore nella creazione del cliente');
                    }
                });
            });

            $('#createCameraForm').submit(function (event) {
                event.preventDefault();
                var cameraData = {
                    NumeroCamera: $('input[name="numeroCamera"]').val(),
                    Descrizione: $('input[name="descrizione"]').val(),
                    Tipologia: $('select[name="tipologia"]').val()
                };

                $.ajax({
                    url: 'https://localhost:7153/api/Camere/Create',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(cameraData),
                    success: function (response) {
                        alert('Camera creata con successo!');
                        fetchCamere();
                    },
                    error: function () {
                        alert('Errore nella creazione della camera');
                    }
                });
            });

            function fetchClienti() {
                $.ajax({
                    url: '/api/Clienti',
                    type: 'GET',
                    success: function (clienti) {
                        var clienteSelect = $('#clienteId');
                        clienteSelect.empty(); // Svuota le opzioni esistenti
                        clienti.forEach(function (cliente) {
                            clienteSelect.append(`<option value="${cliente.id}">${cliente.nome} ${cliente.cognome}</option>`);
                        });
                    },
                    error: function () {
                        console.error('Errore nel caricamento dei clienti');
                    }
                });
            }

            function fetchCamere() {
                $.ajax({
                    url: '/api/Camere',
                    type: 'GET',
                    success: function (camere) {
                        var cameraSelect = $('#cameraId');
                        cameraSelect.empty(); // Svuota le opzioni esistenti
                        camere.forEach(function (camera) {
                            cameraSelect.append(`<option value="${camera.id}">${camera.numeroCamera} - ${camera.descrizione}</option>`);
                        });
                    },
                    error: function () {
                        console.error('Errore nel caricamento delle camere');
                    }
                });
            }

            fetchPrenotazioni();
            fetchClienti();
            fetchCamere();
        });
    </script>
</body>
</html>
